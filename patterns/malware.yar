/*
    YARA Rules for Email Attachment Malware Detection
    Basic rule set for common threats
*/

rule Suspicious_Macro
{
    meta:
        description = "Detects suspicious VBA macro patterns"
        author = "Phishing Analyzer"
        severity = "high"
    
    strings:
        $auto1 = "AutoOpen" nocase
        $auto2 = "AutoExec" nocase
        $auto3 = "Document_Open" nocase
        $auto4 = "Workbook_Open" nocase
        
        $exec1 = "Shell" nocase
        $exec2 = "WScript.Shell" nocase
        $exec3 = "CreateObject" nocase
        
        $net1 = "URLDownloadToFile" nocase
        $net2 = "MSXML2.XMLHTTP" nocase
        $net3 = "WinHttp.WinHttpRequest" nocase
        
        $obf1 = "Chr(" nocase
        $obf2 = "StrReverse" nocase
        $obf3 = "Replace(" nocase
    
    condition:
        (any of ($auto*)) and (any of ($exec*) or any of ($net*)) and (any of ($obf*))
}

rule Powershell_Embedded
{
    meta:
        description = "Detects embedded PowerShell commands"
        author = "Phishing Analyzer"
        severity = "high"
    
    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        $ps3 = "Invoke-Expression" nocase
        $ps4 = "IEX" nocase
        $ps5 = "Invoke-WebRequest" nocase
        $ps6 = "DownloadString" nocase
        $ps7 = "DownloadFile" nocase
        
        $enc1 = "-EncodedCommand" nocase
        $enc2 = "-enc" nocase
        $enc3 = "FromBase64String" nocase
    
    condition:
        any of ($ps*) and any of ($enc*)
}

rule Suspicious_JavaScript
{
    meta:
        description = "Detects suspicious JavaScript patterns"
        author = "Phishing Analyzer"
        severity = "medium"
    
    strings:
        $js1 = "eval(" nocase
        $js2 = "unescape(" nocase
        $js3 = "fromCharCode" nocase
        $js4 = "atob(" nocase
        $js5 = "ActiveXObject" nocase
        $js6 = "WScript.Shell" nocase
        $js7 = "document.write" nocase
    
    condition:
        2 of them
}

rule Suspicious_PE_Executable
{
    meta:
        description = "Detects Windows PE executables"
        author = "Phishing Analyzer"
        severity = "high"
    
    strings:
        $mz = { 4D 5A }  // MZ header
        $pe = "PE\x00\x00"
    
    condition:
        $mz at 0 and $pe
}

rule Suspicious_PDF_JavaScript
{
    meta:
        description = "Detects JavaScript in PDF files"
        author = "Phishing Analyzer"
        severity = "medium"
    
    strings:
        $pdf = "%PDF"
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $aa = "/AA" // Auto action
        $oa = "/OpenAction"
    
    condition:
        $pdf at 0 and (any of ($js*) or $aa or $oa)
}

rule Embedded_Executable
{
    meta:
        description = "Detects embedded executables in Office documents"
        author = "Phishing Analyzer"
        severity = "critical"
    
    strings:
        $ole = { D0 CF 11 E0 A1 B1 1A E1 }  // OLE header
        $mz = { 4D 5A }  // MZ header
        $exe_string = ".exe" nocase
    
    condition:
        $ole at 0 and $mz and $exe_string
}

rule Credential_Harvesting
{
    meta:
        description = "Detects credential harvesting attempts"
        author = "Phishing Analyzer"
        severity = "high"
    
    strings:
        $form1 = "<form" nocase
        $form2 = "password" nocase
        $form3 = "username" nocase
        $form4 = "login" nocase
        $form5 = "signin" nocase
        
        $post1 = "method=\"post\"" nocase
        $post2 = "method='post'" nocase
    
    condition:
        $form1 and 2 of ($form2, $form3, $form4, $form5) and any of ($post*)
}

rule URL_Shortener
{
    meta:
        description = "Detects URL shortening services"
        author = "Phishing Analyzer"
        severity = "low"
    
    strings:
        $s1 = "bit.ly" nocase
        $s2 = "tinyurl" nocase
        $s3 = "goo.gl" nocase
        $s4 = "t.co" nocase
        $s5 = "ow.ly" nocase
        $s6 = "is.gd" nocase
    
    condition:
        any of them
}

rule Base64_Encoded_Content
{
    meta:
        description = "Detects base64 encoded suspicious content"
        author = "Phishing Analyzer"
        severity = "medium"
    
    strings:
        $b64_ps = "cG93ZXJzaGVsbA" // "powershell" in base64
        $b64_cmd = "Y21kLmV4ZQ" // "cmd.exe" in base64
        $b64_wscript = "d3NjcmlwdA" // "wscript" in base64
        $b64_invoke = "SW52b2tlLUV4cHJlc3Npb24" // "Invoke-Expression" in base64
    
    condition:
        any of them
}

rule Suspicious_IP_Address
{
    meta:
        description = "Detects embedded IP addresses"
        author = "Phishing Analyzer"
        severity = "low"
    
    strings:
        $ip = /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/
    
    condition:
        #ip > 3
}
